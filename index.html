<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmap of Student Pairs</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .cell {
            stroke: #fff;
        }
        .axis text {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <script>
        // Define dimensions
        const margin = {top: 50, right: 30, bottom: 150, left: 100};
        const width = 800 - margin.left - margin.right;
        const height = 800 - margin.top - margin.bottom;

        // Create SVG container
        const svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Load the data
        d3.csv("data.csv").then(data => {
            console.log(data);  // Log the data to check if it's loaded correctly

            // Extract unique students and sort them
            const students = Array.from(new Set(data.flatMap(d => [d["Student 1"], d["Student 2"]]))).sort();

            // Create a mapping for each student to their index in the matrix
            const studentIndex = students.reduce((acc, student, idx) => {
                acc[student] = idx;
                return acc;
            }, {});

            // Create an empty matrix for the heatmap (symmetric)
            const heatmapMatrix = Array(students.length).fill().map(() => Array(students.length).fill(0));

            // Populate the matrix with grades
            data.forEach(row => {
                const student1 = row["Student 1"];
                const student2 = row["Student 2"];
                const grade = +row["Average_Grade"];

                // Ensure the pair is ordered (symmetry)
                const i = studentIndex[Math.min(student1, student2)];
                const j = studentIndex[Math.max(student1, student2)];

                // If the value is already set, take the average grade for that pair
                if (heatmapMatrix[i][j] !== 0) {
                    heatmapMatrix[i][j] = (heatmapMatrix[i][j] + grade) / 2;
                } else {
                    heatmapMatrix[i][j] = grade;
                }

                // Set the symmetric value as well
                heatmapMatrix[j][i] = heatmapMatrix[i][j];
            });

            // Set the color scale
            const colorScale = d3.scaleSequential(d3.interpolateYlGnBu)
                .domain([d3.min(heatmapMatrix.flat()), d3.max(heatmapMatrix.flat())]);

            // Create the scales for x and y axes
            const xScale = d3.scaleBand()
                .domain(students)
                .range([0, width])
                .padding(0.05);

            const yScale = d3.scaleBand()
                .domain(students)
                .range([height, 0])
                .padding(0.05);

            // Draw the heatmap cells
            svg.selectAll()
                .data(heatmapMatrix.flat())
                .enter()
                .append("rect")
                .attr("x", (d, i) => xScale(students[i % students.length]))
                .attr("y", (d, i) => yScale(students[Math.floor(i / students.length)]))
                .attr("width", xScale.bandwidth())
                .attr("height", yScale.bandwidth())
                .style("fill", d => colorScale(d))
                .classed("cell", true);

            // Add text labels inside cells
            svg.selectAll()
                .data(heatmapMatrix.flat())
                .enter()
                .append("text")
                .attr("x", (d, i) => xScale(students[i % students.length]) + xScale.bandwidth() / 2)
                .attr("y", (d, i) => yScale(students[Math.floor(i / students.length)]) + yScale.bandwidth() / 2)
                .attr("dy", "0.35em")
                .style("text-anchor", "middle")
                .text(d => d ? d.toFixed(1) : "")
                .style("font-size", "12px");

            // Draw the axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .style("font-size", "12px");

            svg.append("g")
                .call(d3.axisLeft(yScale))
                .selectAll("text")
                .style("font-size", "12px");

        }).catch(error => {
            console.error("Error loading CSV data: ", error);
        });
    </script>
</body>
</html>
